name: Nathan Commit Gate

on:
  pull_request:
    types: [synchronize]

permissions:
  contents: read
  pull-requests: read
  actions: write

jobs:
  dispatch-nathan:
    # Do not allow fork PRs to auto-dispatch the secret-bearing workflow.
    if: ${{ github.event.pull_request != null && github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate dispatcher permissions (maintainers only)
        id: perm
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
        shell: bash
        run: |
          set -euo pipefail

          permission="$(gh api -H "Accept: application/vnd.github+json" \
            "repos/${REPO}/collaborators/${ACTOR}/permission" \
            --jq '.permission // ""' 2>/dev/null || true)"

          case "${permission}" in
            admin|maintain)
              echo "allowed=true" >> "$GITHUB_OUTPUT"
              echo "✅ ${ACTOR} has ${permission} permission."
              ;;
            *)
              echo "allowed=false" >> "$GITHUB_OUTPUT"
              echo "⏭️ ${ACTOR} is not a maintainer (permission='${permission:-none}'); skipping dispatch."
              ;;
          esac

      - name: Check latest commit message (+Nathan)
        id: gate
        if: ${{ steps.perm.outputs.allowed == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        shell: bash
        run: |
          set -euo pipefail

          commits_json="$(gh api --paginate "repos/${REPO}/pulls/${PR_NUMBER}/commits" | jq -s 'add')"
          sha="$(printf '%s' "$commits_json" | jq -r '.[-1].sha // ""')"
          msg="$(printf '%s' "$commits_json" | jq -r '.[-1].commit.message // ""')"

          shopt -s nocasematch
          if [[ "$msg" == *"+nathan"* ]]; then
            echo "triggered=true" >> "$GITHUB_OUTPUT"
          else
            echo "triggered=false" >> "$GITHUB_OUTPUT"
          fi
          shopt -u nocasematch

          first_line="$(printf '%s\n' "$msg" | head -n1 | tr -d '\r')"
          echo "Latest PR commit: ${sha:-unknown} — ${first_line:-<no message>}"

      - name: Dispatch Nathan workflow
        if: ${{ steps.perm.outputs.allowed == 'true' && steps.gate.outputs.triggered == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${HEAD_REF:-}" ]]; then
            echo "Missing PR head ref; cannot dispatch."
            exit 1
          fi

          echo "Dispatching trigger-n8n-workflow.yml for PR #${PR_NUMBER} on ref ${HEAD_REF}"
          gh api -X POST "repos/${REPO}/actions/workflows/trigger-n8n-workflow.yml/dispatches" \
            -f ref="${HEAD_REF}" \
            -f inputs[pr_number]="${PR_NUMBER}"
