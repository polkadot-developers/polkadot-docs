#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Running Prettier on .snippets/code/**/*.{js,json,html}"
npx prettier --write .snippets/code/**/*.{js,json,html}

# Find all TOML files and normalize paths
ALL_FILES=$(find .snippets/code/ -type f -name "*.toml" | sed 's|//|/|g')

# Run Taplo if there are files to format
if [ -n "$ALL_FILES" ]; then
  echo "Formatting files with Taplo..."
  echo "$ALL_FILES" | while read -r file; do
    echo "Formatting $file"
    npx taplo fmt "$file"
    if [ $? -ne 0 ]; then
      echo "Error: Taplo formatting failed."
      exit 1
    fi
  done
else
  echo "No files to format."
fi

echo "Adding formatted files back to the commit..."

# Collect files to add
FILES_TO_ADD=$(find .snippets/code/ -type f \( -name "*.js" -o -name "*.json" -o -name "*.html" -o -name "*.toml" \))

if [ -n "$FILES_TO_ADD" ]; then
  echo "$FILES_TO_ADD" | xargs git add
else
  echo "No files to add."
fi

# Run the Python script to generate llms.txt
echo "Running Python script to generate llms.txt..."
python3 scripts/generate_llms.py

# Check if llms.txt was generated and add it to the commit
if [ -f "llms.txt" ]; then
  echo "Staging llms.txt file..."
  git add llms.txt
else
  echo "No llms.txt file generated."
fi