/* AI File Actions script
   Handles interactions for the file actions dropdown (Copy, View, Download) 
   generated by the ai_file_actions plugin.
*/

(function () {
  'use strict';

  if (typeof window === 'undefined') {
    return;
  }

  // ---------- Toast Notifications ----------
  // Reuses Material for MkDocs' built-in .md-dialog element (the same one
  // used by code-block copy buttons) instead of a custom toast.
  function showToast(message) {
    const dlg = document.querySelector('.md-dialog');
    if (dlg) {
      const msg = dlg.querySelector('.md-dialog__inner');
      if (msg) msg.textContent = message;
      dlg.classList.add('md-dialog--active');
      setTimeout(function () {
        dlg.classList.remove('md-dialog--active');
      }, 2000);
    }
  }

  // ---------- Analytics ----------

  function sendAnalytics(actionId) {
    if (typeof window.gtag === 'function') {
      try {
        window.gtag('event', 'ai_file_action', {
          event_category: 'engagement',
          event_label: actionId,
        });
      } catch (e) {
        /* silently fail */
      }
    }
  }

  // ---------- Clipboard / Download Logic ----------

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (error) {
      let copied = false;
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      /* If clipboard API is not available, fallback to execCommand, which still works in most browsers */
      try {
        copied = document.execCommand('copy');
      } catch (fallbackError) {
        console.error('Copy fallback failed', fallbackError);
      }
      document.body.removeChild(textarea);

      if (!copied) {
        throw error;
      }
      return true;
    }
  }

  async function handleCopy(button) {
    const url = button.dataset.url;
    if (!url) return;

    try {
      const response = await fetch(url, { credentials: 'omit' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const text = await response.text();

      await copyToClipboard(text);

      showToast('Content copied to clipboard!');
    } catch (error) {
      console.error('Copy error:', error);
      showToast('Failed to copy content');
    }
  }

  async function handleDownload(linkElement) {
    const originalHref = linkElement.href;
    linkElement.dataset.downloading = 'true';

    try {
      const response = await fetch(originalHref, { credentials: 'omit' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const blob = await response.blob();
      const objectUrl = URL.createObjectURL(blob);

      linkElement.href = objectUrl;
      linkElement.click(); // Re-enters event handler but flag lets it pass through natively

      setTimeout(function () {
        URL.revokeObjectURL(objectUrl);
      }, 100);
      showToast('Download started');
    } catch (error) {
      console.error('Download error:', error);
      showToast('Failed to download file');
    } finally {
      linkElement.href = originalHref;
      delete linkElement.dataset.downloading;
    }
  }

  // ---------- Dropdown Helpers ----------

  function closeDropdown(menu) {
    if (!menu) return;
    menu.classList.remove('show');
    const trigger = menu.parentElement.querySelector(
      '.ai-file-actions-trigger',
    );
    if (trigger) {
      trigger.classList.remove('active');
      trigger.setAttribute('aria-expanded', 'false');
    }
  }

  function closeAllDropdowns(except) {
    document.querySelectorAll('.ai-file-actions-menu.show').forEach((d) => {
      if (d !== except) closeDropdown(d);
    });
  }

  // ---------- Event Delegation ----------

  document.addEventListener('click', function (event) {
    // Handle Dropdown Toggle
    const toggleBtn = event.target.closest('.ai-file-actions-trigger');
    if (toggleBtn) {
      event.preventDefault();
      event.stopPropagation();

      // Close other dropdowns
      closeAllDropdowns(toggleBtn.nextElementSibling);

      const dropdown = toggleBtn.nextElementSibling; // The menu is right after the button
      if (dropdown) {
        dropdown.classList.toggle('show');
        const isExpanded = dropdown.classList.contains('show');
        toggleBtn.setAttribute('aria-expanded', isExpanded);
        toggleBtn.classList.toggle('active', isExpanded);
        if (isExpanded) {
          const first = dropdown.querySelector('.ai-file-actions-item');
          if (first) first.focus();
        }
      }
      return;
    }

    // Handle Copy Action (Left Button)
    const copyBtn = event.target.closest('.ai-file-actions-copy');
    if (copyBtn) {
      event.preventDefault();
      sendAnalytics(copyBtn.dataset.action || 'copy-markdown');
      handleCopy(copyBtn);
      return;
    }

    // Handle Dropdown Items
    const item = event.target.closest('.ai-file-actions-item');
    if (item) {
      // Close the dropdown
      closeDropdown(item.closest('.ai-file-actions-menu'));

      sendAnalytics(item.dataset.actionId || '');

      // Download links: intercept to force download via fetch+blob
      // On re-entry from handleDownload's .click(), the flag is set
      // so we skip preventDefault() and let the browser download the blob natively
      if (item.hasAttribute('download')) {
        if (!item.dataset.downloading) {
          event.preventDefault();
          handleDownload(item);
        }
        return;
      }

      // Plain links (<a> without download): let the browser handle natively
      if (item.tagName === 'A') {
        return;
      }

      // Clipboard buttons
      if (item.dataset.actionType === 'clipboard') {
        event.preventDefault();
        handleCopy(item);
      }
      return;
    }

    // Close dropdowns when clicking outside
    if (!event.target.closest('.ai-file-actions-container')) {
      closeAllDropdowns();
    }
  });

  // ---------- Keyboard Navigation ----------

  document.addEventListener('keydown', function (event) {
    const menu = document.querySelector('.ai-file-actions-menu.show');
    if (!menu) return;

    const items = Array.from(menu.querySelectorAll('.ai-file-actions-item'));
    if (!items.length) return;

    const currentIndex = items.findIndex(
      (item) => item === document.activeElement,
    );

    switch (event.key) {
      case 'ArrowDown':
        event.preventDefault();
        items[
          currentIndex === -1 ? 0 : (currentIndex + 1) % items.length
        ].focus();
        break;
      case 'ArrowUp':
        event.preventDefault();
        items[
          currentIndex === -1
            ? items.length - 1
            : (currentIndex - 1 + items.length) % items.length
        ].focus();
        break;
      case 'Enter':
      case ' ':
        event.preventDefault();
        if (currentIndex >= 0) items[currentIndex].click();
        break;
      case 'Escape':
        event.preventDefault();
        closeDropdown(menu);
        const trigger = menu.parentElement.querySelector(
          '.ai-file-actions-trigger',
        );
        if (trigger) trigger.focus();
        break;
    }
  });
})();
